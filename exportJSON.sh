#!/bin/bash
dir="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )/data.json"
psql postgresql://postgres:bazepodataka@127.0.0.1:5432/VideoGamePublishers -f - <<EOF
\copy (select json_agg(row_to_json(publisherList)) as "publishers" from (select publishers.id as "publisherID", publishers.name as "publisherName", publishers."dateFounded" as "publisherDateFounded", publishers.country as "publisherCountry", publishers.description as "publisherDesc", publishers.website as "publisherWebsite", json_build_object('name', directors.name, 'surname', directors.surname) as "publisherDirector", (select json_agg(row_to_json(publisherStudios)) from (select studios.name as "name", studios.country as "country", studios."dateFounded" as "dateFounded", studios."numDevelopers", json_build_object('name', directors.name, 'surname', directors.surname) as "director", (select json_agg(row_to_json(titles)) from (select games.name as "title", games."releaseDate" as "releaseDate", genre from games where games."idStudio" = studios.id) as titles) as "titles" from studios left join directors on studios."idDirector" = directors.id where studios."idPublisher" = publishers.id) as publisherStudios) as "studios" from publishers left join directors on publishers."idDirector" = directors.id) as publisherList) to '$dir';
